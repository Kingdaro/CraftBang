local errors = false
local url = "https://bitbucket.org/Kingdaro/craftbang-de/raw/6b6578a572c9b0831ac9fd56c79eab2b9a43e2e1/craftbang/"
local filelist = {
	'desktop';
	'dialog';
	'panel';
	'session';
	'terminal';
	'lib/arealib';
	'lib/redirect';
}

local startupContent = [[
-- CraftBang Startup
if shell.getRunningProgram() == "craftbang/session" then
	print "CraftBang session is already running."
	return
end
shell.run("craftbang/session")
]]

if fs.exists('/craftbang') then
	fs.delete('/craftbang')
end
fs.makeDir('/craftbang')
fs.makeDir('/craftbang/lib')

for i=1, #filelist do
	local filename = filelist[i]
	local fullurl = url .. filename
	local localpath = '/craftbang/'..filename

	local download = http.get(fullurl)
	if download then
		print("Writing "..localpath)
		local file = fs.open(localpath, 'w')
		file.write(download.readAll())
		file.close()
	else
		print("Couldn't get "..filename)
		errors = true
	end
end

print''
if errors then
	print "Install wasn't completely successful, it seems."
	fs.delete('craftbang')
	print "Changes have been rolled back."
	return
else
	print "Installation went off without a hitch!"
end

local function getInput(onYes, onNo)
	while true do
		local input = read():lower():sub(1,1)
		if input == 'y' then
			onYes()
			break
		elseif input == 'n' then
			onNo()
			break
		end
		print "Invalid input."
	end
end

print''
write "Run CraftBang on startup? "
if fs.exists('startup') then
	local file = fs.open('startup', 'r')
	local firstLine = file.readLine()
	file.close()
	
	if not firstLine:match("CraftBang Startup") then
		term.setTextColor(colors.gray)
		print "\n( Your current startup file will be moved to /autorun, and will be automatically started when CraftBang runs. )"
		term.setTextColor(colors.white)
	else
		fs.delete('startup')
	end
end
write "[y/n] "

local saidYes = false
print''
getInput(
	function()
		if not fs.exists('autorun') then
			fs.makeDir('autorun')
		end
		if fs.exists('startup') then
			if fs.exists('autorun/startup') then
				fs.delete('autorun/startup')
			end
			fs.move('startup', 'autorun/startup')
			print "Startup moved to /autorun."
		end

		local startup = fs.open('startup', 'w')
		startup.write(startupContent)
		startup.close()
		print "CraftBang will now run on startup."
		saidYes = true
	end,
	function()
		print "In that case, run craftbang/session to start CraftBang."
	end
)

write "Restart now? [y/n] "

local function eject()
	for _, v in pairs(rs.getSides()) do
		disk.eject(v)
	end
end

getInput(
	function()
		if saidYes then
			print "\nSee you in CraftBang!"
			sleep(1)
		end
		eject()
		os.reboot()
	end,
	function()
		print "\nI'll let you get back to your shell then."
		print "Do whatever you need to do."
		eject()
	end
)

