if not http then
	print "It doesn't seem like you have http enabled."
	print "Enable it first, restart minecraft, then run this file again."
	return
end

local errors = false
local url = "https://bitbucket.org/Kingdaro/craftbang-de/raw/6b6578a572c9b0831ac9fd56c79eab2b9a43e2e1/craftbang/"
local filelist = {
	'desktop';
	'dialog';
	'panel';
	'session';
	'terminal';
	'lib/arealib';
	'lib/redirect';
}

if fs.exists('/craftbang') then
	fs.delete('/craftbang')
end
fs.makeDir('/craftbang')
fs.makeDir('/craftbang/lib')

for i=1, #filelist do
	local filename = filelist[i]
	local fullurl = url .. filename
	local localpath = '/craftbang/'..filename

	local download = http.get(fullurl)
	if download then
		print("Writing "..localpath)
		local file = fs.open(localpath, 'w')
		file.write(download.readAll())
		file.close()
	else
		print("Couldn't get "..filename)
		errors = true
	end
end

print''
if errors then
	print "Install wasn't completely successful, it seems."
	fs.delete('craftbang')
	print "Changes have been rolled back."
	return
else
	print "Installation went off without a hitch!"
end

local function getInput(onYes, onNo)
	while true do
		local input = read():lower():sub(1,1)
		if input == 'y' then
			onYes()
			break
		elseif input == 'n' then
			onNo()
			break
		end
		print "Invalid input."
	end
end

print''
print "Run CraftBang on startup?"
term.setTextColor(colors.gray)
print "( Your current startup file will be moved to /autorun, and will be automatically started when CraftBang runs. )"
term.setTextColor(colors.white)
write "[y/n] "

local saidYes = false
getInput(
	function()
		print''
		if fs.exists('startup') then
			if not fs.exists('/autorun') then
				fs.makeDir('/autorun')
			end
			if fs.exists('/autorun/startup') then
				print "/autorun/startup already exists"
			else
				fs.move('startup', 'autorun/startup')
				print "Startup moved to /autorun."
			end
		end

		local startup = fs.open('startup', 'w')
		startup.writeLine[[shell.run("craftbang/session")]]
		print "CraftBang will now run on startup."
		saidYes = true
	end,
	function()
		print''
		print "In that case, run craftbang/session to start CraftBang."
	end
)

write "Restart now? [y/n] "

getInput(
	function()
		if saidYes then
			print "\nSee you in CraftBang!"
			sleep(1)
		end
		for _, v in pairs(rs.getSides()) do
			disk.eject(v)
		end
		os.reboot()
	end,
	function()
		print "\nI'll let you get back to your shell then."
		print "Do whatever you need to do."
	end
)
